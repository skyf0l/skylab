- name: Get Kubernetes api server endpoint
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_local_path }}"
    kind: Endpoints
    namespace: default
    name: kubernetes
  register: k8s_api_server_endpoint
  failed_when: k8s_api_server_endpoint.resources | length == 0
  retries: 30
  delay: 30

- name: Set kubernetes api server endpoint variables
  ansible.builtin.set_fact:
    k8s_api_server_endpoint_ip: "{{ k8s_api_server_endpoint.resources[0].subsets[0].addresses[0].ip }}"
    k8s_api_server_endpoint_port: "{{ k8s_api_server_endpoint.resources[0].subsets[0].ports[0].port }}"

- ansible.builtin.debug:
    msg: "Kubernetes API Server Endpoint: {{ k8s_api_server_endpoint_ip }}:{{ k8s_api_server_endpoint_port }}"

- name: Deploy Cilium chart (managed later by ArgoCD)
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig_local_path }}"
    name: cilium
    chart_ref: "{{ repo_root }}/k8s/projects/cluster-stack/cilium"
    values_files:
      - "{{ repo_root }}/k8s/projects/cluster-stack/cilium/values.yaml"
      - "{{ repo_root }}/k8s/projects/cluster-stack/cilium/values/{{ cluster_name }}.yaml"
    set_values:
      - value: "cilium.k8sServiceHost={{ k8s_api_server_endpoint_ip }}"
      - value: "cilium.k8sServicePort={{ k8s_api_server_endpoint_port }}"
    release_namespace: kube-system
    dependency_update: true
    wait: true

# Node should be ready after CNI installation
- name: Wait until all Nodes are Ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_local_path }}"
    kind: Node
  register: node_info
  until: >
    (node_info.resources | length) > 0 and
    (
      node_info.resources
      | json_query("[?status.conditions[?type=='Ready' && status=='True']]")
      | length
    ) == (node_info.resources | length)
  retries: 60
  delay: 10
